{% extends 'gitmanager_frame.html' %}
{% load i18n %}

{% block logout_button %}{% endblock %}

{% block heading %}Login{% endblock %}

{% block body %}
<form id="login-form">
    <div class="d-flex align-items-center w-25" style="min-width: fit-content;">
        <label for="token" class="text-nowrap me-2">Access token:</label>
        <div class="input-group">
            <input type="text" name="token" class="form-control"></input>
            <input type="submit" value="Login" class="btn btn-primary">
        </div>
    </div>
</form>
<div id="error"></div>
<script>
    document.getElementById("login-form").addEventListener("submit", (e) => {
        e.preventDefault();

        const data = new FormData(e.target);

        const xml = new XMLHttpRequest();
        xml.open("POST", "/login");
        xml.setRequestHeader("Authorization", "Bearer " + data.get("token"))
        xml.onload = () => {
            console.log(xml);
            if(xml.status == 200) {
                window.location.href = new URLSearchParams(window.location.search).get("referer") ?? "/";
            } else if(xml.status == 501) {
                document.getElementById("error").textContent = xml.responseText;
            } else {
                document.getElementById("error").textContent = xml.statusText;
            }
        };
        xml.onerror = () => document.getElementById("error").textContent = xml.statusText;
        xml.send();

        return false;
    })
</script>
{% endblock %}
